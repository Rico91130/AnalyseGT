<!DOCTYPE html>
<html lang="fr">
<head>
  
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
<link rel="stylesheet" href="https://jerosoler.github.io/Drawflow/beautiful.css">

<script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>
<script>

var editor = null;


    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false );
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;
   function positionMobile(ev) {
     mobile_last_move = ev;
   }

   function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
      ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint( mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if(parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }

    }

    function addNodeToDrawFlow(name, pos_x, pos_y) {
      if(editor.editor_mode === 'fixed') {
        return false;
      }
      pos_x = pos_x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)) - (editor.precanvas.getBoundingClientRect().x * ( editor.precanvas.clientWidth / (editor.precanvas.clientWidth * editor.zoom)));
      pos_y = pos_y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)) - (editor.precanvas.getBoundingClientRect().y * ( editor.precanvas.clientHeight / (editor.precanvas.clientHeight * editor.zoom)));


      switch (name) {
        case 'APIQuery':
          var APIQueryTemplate = `
          <div>
            <div class="title-box">Requetage API</div>
            <div class="box">
              <p>URL : </p>
            <input type="text" df-name>
            </div>
          </div>
          `;
          editor.addNode('APIQuery', 0, 1, pos_x, pos_y, 'APIQuery', { "name": ''}, APIQueryTemplate);
          break;
          case 'FilterQuery':
          var FilterQueryTemplate = `
          <div>
            <div class="title-box">Filtrer liste</div>
            <div class="box">
                Condition
                <textarea df-template></textarea>
                Element courant : item
              </div>
            </div>
          `;
          editor.addNode('FilterQuery', 1, 1, pos_x, pos_y, 'FilterQuery', { "name": ''}, FilterQueryTemplate);
          break;
        default:
      }
    }


    function init() {

        var id = document.getElementById("drawflow");
    editor = new Drawflow(id);
    editor.reroute = true;
    const dataToImport = {
    "drawflow": {
        "Home": {
            "data": {
 
            }
        },
        "Other": {
            "data": {
            }
        }
    }
};

    editor.start();
    editor.import(dataToImport);

    }
</script>

</head>
<body onload="init()">
    <header>
        <h2>Analyse GT</h2>

      </header>
    <div class="wrapper">
        <div class="col">
            <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="APIQuery">
                <span>Requetage API</span>
              </div>
              <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="FilterQuery">
                <span>Filtrer liste</span>
              </div>
        </div>
            <div class="col-right">
                <div class="menu">
                  <ul>
                    <li onclick="editor.changeModule('Home'); changeModule(event);" class="selected">Home</li>
                    <li onclick="editor.changeModule('Other'); changeModule(event);">Other Module</li>
                  </ul>
                </div>
                <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
          
                  <div class="btn-export" onclick="Swal.fire({ title: 'Export',
                  html: '<pre><code>'+JSON.stringify(editor.export(), null,4)+'</code></pre>'
                  })">Export</div>
                  <div class="btn-clear" onclick="editor.clearModuleSelected()">Clear</div>
                  <div class="btn-lock">
                    <i id="lock" class="fas fa-lock" onclick="editor.editor_mode='fixed'; changeMode('lock');"></i>
                    <i id="unlock" class="fas fa-lock-open" onclick="editor.editor_mode='edit'; changeMode('unlock');" style="display:none;"></i>
                  </div>
                  <div class="bar-zoom">
                    <i class="fas fa-search-minus" onclick="editor.zoom_out()"></i>
                    <i class="fas fa-search" onclick="editor.zoom_reset()"></i>
                    <i class="fas fa-search-plus" onclick="editor.zoom_in()"></i>
                  </div>
                </div>

            </div>
</div>

</body>
</html>